# 質問明確化機能 テストガイド

## 概要

このドキュメントは、チャット機能の質問明確化機能（フェーズ2）のテスト方法を説明します。

## 前提条件

- Dockerコンテナが起動していること
- `.env`に`ENABLE_CLARIFICATION=true`が設定されていること
- `DEFAULT_MAX_TOKENS=300`が設定されていること

## テストケース

### テストケース1: 抽象的な質問（明確化質問が表示される）

**目的**: 抽象的な質問に対して3つの追加質問と選択肢が表示されることを確認

**手順**:
1. アプリケーションにログイン
2. チャット画面を開く
3. 「機械学習について教えて」と入力して送信

**期待される結果**:
- AIが3つの追加質問を提示する
- 各質問に対して2-4個の選択肢がクリック可能なチップとして表示される
- 「全体像を知りたい」などのクイック選択肢も表示される
- 応答時間は約2-3秒以内

**確認ポイント**:
- [ ] 選択肢チップが表示される
- [ ] 選択肢にホバーすると色が変わる
- [ ] 選択肢をクリックすると自動的にメッセージが送信される
- [ ] ローディング中は選択肢がクリック不可になる

---

### テストケース2: 具体的な質問（通常応答）

**目的**: 具体的な質問に対しては明確化質問が表示されず、通常応答が返ることを確認

**手順**:
1. チャット画面で「Pythonで線形回帰を実装する手順を教えて」と入力して送信

**期待される結果**:
- 明確化質問は表示されない
- 通常のAI応答が返る
- 応答時間は約3-4秒以内（通常モード）
- 文字数は約400文字程度

**確認ポイント**:
- [ ] 選択肢チップが表示されない
- [ ] 通常のテキスト応答のみが表示される
- [ ] 応答が簡潔（400文字程度）

---

### テストケース3: 長考モード（明確化なし）

**目的**: 長考モード（research, deepen）では抽象的な質問でも明確化質問が表示されないことを確認

**手順**:
1. 応答スタイルセレクターで「research（研究・調査）」を選択
2. 「機械学習について教えて」と入力して送信

**期待される結果**:
- 明確化質問は表示されない
- 詳細な応答が返る（文字数制限なし）
- 応答時間は約10秒前後

**確認ポイント**:
- [ ] 選択肢チップが表示されない
- [ ] 詳細な応答が返る（800文字以上）
- [ ] トークン数制限が適用されていない

---

### テストケース4: 選択肢クリックの動作

**目的**: 選択肢クリックが正常に動作し、次の応答が得られることを確認

**手順**:
1. 「日本の歴史について教えて」と入力
2. 表示された選択肢の中から1つをクリック（例: 「江戸時代」）
3. AI応答を確認

**期待される結果**:
- クリックした選択肢がユーザーメッセージとして送信される
- 選択した内容に基づいた詳細な応答が返る
- スクロールが自動的に最下部に移動する

**確認ポイント**:
- [ ] クリックした選択肢がユーザーメッセージとして表示される
- [ ] AIが選択した内容に沿った応答を返す
- [ ] 自動スクロールが機能する

---

### テストケース5: モバイルでの表示

**目的**: モバイル環境で選択肢チップが適切に表示されることを確認

**手順**:
1. ブラウザの開発者ツールでモバイルビュー（375px幅）に切り替え
2. 「音楽について教えて」と入力
3. 表示された選択肢の配置を確認

**期待される結果**:
- 選択肢チップが折り返して表示される
- フォントサイズが小さくなる（0.8rem）
- タップしやすいサイズを維持している

**確認ポイント**:
- [ ] 選択肢が画面幅に収まる
- [ ] 文字が読みやすい
- [ ] タップ領域が十分

---

### テストケース6: エラーハンドリング

**目的**: JSONパースエラーなどが発生した場合のフォールバック動作を確認

**手順**:
1. バックエンドログを監視
2. 複数の抽象的な質問を送信
3. エラーログを確認

**期待される動作**:
- JSONパースエラーが発生しても、フォールバックメッセージが表示される
- アプリケーションがクラッシュしない
- ユーザーに適切なメッセージが表示される

**確認ポイント**:
- [ ] エラーが発生してもアプリが動作する
- [ ] ログに警告が記録される
- [ ] ユーザーに代替メッセージが表示される

---

### テストケース7: 複数回の質問明確化

**目的**: 明確化質問に選択肢で答えた後、さらに明確化質問が表示されるか確認

**手順**:
1. 「世界の文化について教えて」と入力
2. 表示された選択肢から1つ選択
3. 再度抽象的な応答であれば、さらに明確化質問が表示されるか確認

**期待される結果**:
- 必要に応じて複数回の明確化が行われる
- 最終的に具体的な応答が得られる

---

## パフォーマンステスト

### 応答時間の確認

**測定方法**:
1. ブラウザの開発者ツール（Network タブ）を開く
2. 各テストケースでメッセージを送信
3. `/chat` APIのレスポンス時間を記録

**目標値**:
- 明確化質問生成: 2-3秒
- 通常応答（organize, expand, ideas）: 3-4秒
- 長考モード（research, deepen）: 10秒前後

---

## トラブルシューティング

### 問題: 選択肢が表示されない

**原因候補**:
- `ENABLE_CLARIFICATION`が`false`になっている
- 質問が具体的すぎる
- 応答スタイルが`research`または`deepen`になっている

**解決方法**:
1. `.env`を確認
2. より抽象的な質問を試す
3. 応答スタイルを`auto`に変更

---

### 問題: 選択肢が多すぎて表示が崩れる

**原因**:
- LLMが多数の選択肢を生成している

**解決方法**:
- プロンプト（CLARIFICATION_PROMPT）を調整
- 選択肢の数を2-4個に制限するよう明示

---

### 問題: JSONパースエラーが頻発する

**原因**:
- LLMの出力が不安定

**解決方法**:
1. プロンプトをより具体的に修正
2. 温度パラメータを下げる（より決定論的に）
3. フォールバック処理が正常に動作しているか確認

---

## ログ確認

**バックエンドログ**:
```bash
docker-compose logs -f backend
```

**確認項目**:
- `Clarification failed, falling back to normal response` → 明確化失敗
- `JSON parse failed for clarification` → JSONパースエラー
- 質問意図分類の結果（abstract/specific）

---

## チェックリスト

実装完了後、以下を確認してください:

- [ ] テストケース1-7がすべてパスする
- [ ] パフォーマンス目標を達成している
- [ ] モバイル・デスクトップ両方で動作する
- [ ] エラーハンドリングが適切に機能する
- [ ] ログに異常なエラーがない
- [ ] UI/UXが直感的で使いやすい

---

## 次のステップ

テストが完了したら:

1. バグや改善点を`CHAT_IMPROVEMENT_PLAN.md`に記録
2. 必要に応じてUI/UXの微調整
3. プロンプトのチューニング
4. 本番環境へのデプロイ準備

---

**作成日**: 2026年1月26日
**バージョン**: 1.0
