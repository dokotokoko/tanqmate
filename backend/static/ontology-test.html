<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼ã‚°ãƒ©ãƒ•ã‚·ã‚¹ãƒ†ãƒ  ãƒ†ã‚¹ãƒˆ - æ¢Qãƒ¡ã‚¤ãƒˆ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #ff6b2c;
            --primary-light: #ff8a50;
            --primary-dark: #e55a24;
            --secondary-color: #4ecdc4;
            --background-color: #fafafa;
            --surface-color: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            min-height: 0;
        }

        .chat-section {
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: var(--primary-color);
            color: white;
            padding: 15px 20px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mode-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .mode-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 500px;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--primary-color);
        }

        .message.assistant .message-avatar {
            background: var(--secondary-color);
        }

        .message-content {
            background: var(--background-color);
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 70%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-content {
            background: var(--primary-color);
            color: white;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .input-group {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            min-height: 44px;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .send-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-button:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .analysis-panel {
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-tabs {
            display: flex;
            background: var(--background-color);
        }

        .tab-button {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .tab-button.active {
            background: var(--secondary-color);
            color: white;
        }

        .tab-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 600px;
        }

        .graph-visualization {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .node-item {
            background: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .node-type {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .node-text {
            margin: 8px 0;
            font-size: 0.95rem;
        }

        .node-metrics {
            display: flex;
            gap: 16px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .inference-step {
            background: var(--background-color);
            border-left: 4px solid var(--secondary-color);
            padding: 12px 16px;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
        }

        .step-type {
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .step-reasoning {
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .step-metadata {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            gap: 16px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 12px 0;
        }

        .success {
            color: #2e7d32;
            background: #e8f5e8;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 12px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--background-color);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            
            .analysis-panel {
                max-height: 400px;
            }
        }

        .controls {
            background: var(--surface-color);
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox {
            width: 18px;
            height: 18px;
        }

        .control-label {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .user-info {
            background: var(--surface-color);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .auth-input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 120px;
            font-size: 0.9rem;
        }

        .auth-button {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼ã‚°ãƒ©ãƒ•ã‚·ã‚¹ãƒ†ãƒ  ãƒ†ã‚¹ãƒˆ</h1>
            <p>æ¢ç©¶å­¦ç¿’æ”¯æ´AIã®æ¨è«–ãƒ—ãƒ­ã‚»ã‚¹ã‚’å¯è¦–åŒ–ãƒ»åˆ†æã™ã‚‹ãƒ†ã‚¹ãƒˆç’°å¢ƒ</p>
        </div>

        <div class="user-info">
            <div class="control-group">
                <label class="control-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</label>
                <input type="number" id="userId" class="auth-input" value="123" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID">
                <button id="authButton" class="auth-button">èªè¨¼è¨­å®š</button>
            </div>
            <div class="control-group">
                <span class="control-label">èªè¨¼çŠ¶æ…‹: </span>
                <span id="authStatus">æœªè¨­å®š</span>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <input type="checkbox" id="graphMode" class="checkbox" checked>
                <label for="graphMode" class="control-label">ã‚°ãƒ©ãƒ•ãƒ¢ãƒ¼ãƒ‰</label>
            </div>
            <div class="control-group">
                <input type="checkbox" id="debugMode" class="checkbox">
                <label for="debugMode" class="control-label">ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰</label>
            </div>
            <div class="control-group">
                <input type="checkbox" id="inferenceLog" class="checkbox" checked>
                <label for="inferenceLog" class="control-label">æ¨è«–ãƒ­ã‚°</label>
            </div>
            <button id="clearChat" class="auth-button">ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¯ãƒªã‚¢</button>
            <button id="refreshGraph" class="auth-button">ã‚°ãƒ©ãƒ•çŠ¶æ…‹æ›´æ–°</button>
        </div>

        <div class="main-content">
            <div class="chat-section">
                <div class="chat-header">
                    <span>ğŸ¤– ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼AIãƒãƒ£ãƒƒãƒˆ</span>
                    <button id="modeToggle" class="mode-toggle">é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</button>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        <div class="message-avatar">ğŸ¤–</div>
                        <div class="message-content">
                            <div>ã“ã‚“ã«ã¡ã¯ï¼ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼ã‚°ãƒ©ãƒ•ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆã¸ã‚ˆã†ã“ãã€‚æ¢ç©¶ã—ãŸã„ãƒ†ãƒ¼ãƒã«ã¤ã„ã¦è‡ªç”±ã«ãŠè©±ã—ãã ã•ã„ã€‚æ¨è«–ãƒ—ãƒ­ã‚»ã‚¹ã‚’è©³ç´°ã«åˆ†æã—ã¾ã™ã€‚</div>
                            <div class="message-time">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•æ™‚</div>
                        </div>
                    </div>
                </div>
                <div class="chat-input">
                    <div class="input-group">
                        <textarea 
                            id="messageInput" 
                            class="input-field" 
                            placeholder="æ¢ç©¶ã—ãŸã„ãƒ†ãƒ¼ãƒã‚„è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                            rows="2"
                        ></textarea>
                        <button id="sendButton" class="send-button">
                            <span>ğŸ“¤</span>
                            é€ä¿¡
                        </button>
                    </div>
                </div>
            </div>

            <div class="analysis-panel">
                <div class="panel-tabs">
                    <button class="tab-button active" data-tab="graph">ğŸ“Š ã‚°ãƒ©ãƒ•çŠ¶æ…‹</button>
                    <button class="tab-button" data-tab="inference">ğŸ” æ¨è«–ãƒ­ã‚°</button>
                    <button class="tab-button" data-tab="stats">ğŸ“ˆ çµ±è¨ˆ</button>
                </div>

                <div class="tab-content">
                    <div id="graphTab" class="tab-panel active">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="nodeCount">0</div>
                                <div class="stat-label">ãƒãƒ¼ãƒ‰æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="edgeCount">0</div>
                                <div class="stat-label">ã‚¨ãƒƒã‚¸æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="progressValue">0%</div>
                                <div class="stat-label">é€²æ—</div>
                            </div>
                        </div>

                        <div class="graph-visualization" id="graphVisualization">
                            <div>ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>

                        <div id="nodesList">
                            <!-- ãƒãƒ¼ãƒ‰ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>

                        <div id="suggestions">
                            <!-- æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ææ¡ˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>

                    <div id="inferenceTab" class="tab-panel" style="display: none;">
                        <div id="currentTrace">
                            <!-- ç¾åœ¨ã®æ¨è«–ãƒˆãƒ¬ãƒ¼ã‚¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                        
                        <div id="traceHistory">
                            <!-- éå»ã®æ¨è«–ãƒˆãƒ¬ãƒ¼ã‚¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>

                    <div id="statsTab" class="tab-panel" style="display: none;">
                        <div id="systemStats">
                            <div class="loading">
                                <div class="spinner"></div>
                                ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿ä¸­...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let authToken = null;
        let currentTraceId = null;
        let graphData = null;
        let elements = {};

        // DOMContentLoadedå¾Œã«è¦ç´ ã‚’å–å¾—
        document.addEventListener('DOMContentLoaded', () => {
            // DOMè¦ç´ ã‚’å–å¾—
            elements = {
                userId: document.getElementById('userId'),
                authButton: document.getElementById('authButton'),
                authStatus: document.getElementById('authStatus'),
                messageInput: document.getElementById('messageInput'),
                sendButton: document.getElementById('sendButton'),
                chatMessages: document.getElementById('chatMessages'),
                modeToggle: document.getElementById('modeToggle'),
                graphMode: document.getElementById('graphMode'),
                debugMode: document.getElementById('debugMode'),
                inferenceLog: document.getElementById('inferenceLog'),
                clearChat: document.getElementById('clearChat'),
                refreshGraph: document.getElementById('refreshGraph'),
                nodeCount: document.getElementById('nodeCount'),
                edgeCount: document.getElementById('edgeCount'),
                progressValue: document.getElementById('progressValue'),
                graphVisualization: document.getElementById('graphVisualization'),
                nodesList: document.getElementById('nodesList'),
                suggestions: document.getElementById('suggestions'),
                currentTrace: document.getElementById('currentTrace'),
                traceHistory: document.getElementById('traceHistory'),
                systemStats: document.getElementById('systemStats')
            };

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setupEventListeners();
            
            // åˆæœŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            elements.messageInput.focus();
        });

        // APIé–¢æ•°
        const api = {
            async ontologyChat(message) {
                const response = await fetch('/api/ontology-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        message: message,
                        use_graph_mode: elements.graphMode.checked,
                        debug_mode: elements.debugMode.checked,
                        include_inference_log: elements.inferenceLog.checked
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'API ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }

                return await response.json();
            },

            async getGraphState(userId) {
                const response = await fetch(`/api/ontology-graph/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ã‚°ãƒ©ãƒ•çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                return await response.json();
            },

            async getInferenceTrace(traceId) {
                const response = await fetch(`/api/ontology-inference/${traceId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('æ¨è«–ãƒˆãƒ¬ãƒ¼ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                return await response.json();
            },

            async getInferenceVisualization(traceId) {
                const response = await fetch(`/api/ontology-inference/${traceId}/visualization`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('æ¨è«–å¯è¦–åŒ–ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                return await response.json();
            },

            async getUserTraces(userId, limit = 5) {
                const response = await fetch(`/api/ontology-inference/user/${userId}/traces?limit=${limit}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('æ¨è«–å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                return await response.json();
            },

            async getSystemStats() {
                const response = await fetch('/api/ontology-inference/statistics', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                return await response.json();
            }
        };

        // UIæ›´æ–°é–¢æ•°
        const ui = {
            addMessage(role, content, timestamp = new Date()) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
                const timeStr = new Date(timestamp).toLocaleTimeString();
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        <div>${content}</div>
                        <div class="message-time">${timeStr}</div>
                    </div>
                `;
                
                elements.chatMessages.appendChild(messageDiv);
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            },

            showLoading(container, message = 'èª­ã¿è¾¼ã¿ä¸­...') {
                container.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        ${message}
                    </div>
                `;
            },

            showError(container, message) {
                container.innerHTML = `<div class="error">âŒ ${message}</div>`;
            },

            updateGraphTab(data) {
                // çµ±è¨ˆæ›´æ–°
                elements.nodeCount.textContent = data.nodes.length;
                elements.edgeCount.textContent = data.edges.length;
                elements.progressValue.textContent = 
                    Math.round(data.progress.progress * 100) + '%';

                // ã‚°ãƒ©ãƒ•å¯è¦–åŒ–ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                elements.graphVisualization.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">
                            ğŸ“Š ã‚°ãƒ©ãƒ•æ§‹é€ æ¦‚è¦
                        </div>
                        <div style="display: flex; justify-content: space-around; align-items: center;">
                            <div>
                                <div style="width: 60px; height: 60px; background: var(--primary-color); 
                                           border-radius: 50%; display: flex; align-items: center; 
                                           justify-content: center; color: white; font-weight: bold;">
                                    ${data.nodes.length}
                                </div>
                                <div style="margin-top: 8px; font-size: 0.9rem;">ãƒãƒ¼ãƒ‰</div>
                            </div>
                            <div style="color: var(--text-secondary);">â”â”â”â”</div>
                            <div>
                                <div style="width: 60px; height: 60px; background: var(--secondary-color); 
                                           border-radius: 50%; display: flex; align-items: center; 
                                           justify-content: center; color: white; font-weight: bold;">
                                    ${data.edges.length}
                                </div>
                                <div style="margin-top: 8px; font-size: 0.9rem;">ã‚¨ãƒƒã‚¸</div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding: 12px; background: var(--background-color); 
                                   border-radius: 8px; font-size: 0.9rem;">
                            ç¾åœ¨ã®æ®µéš: <strong>${data.progress.stage || 'åˆæœŸæ®µéš'}</strong>
                        </div>
                    </div>
                `;

                // ãƒãƒ¼ãƒ‰ä¸€è¦§
                if (data.nodes.length > 0) {
                    elements.nodesList.innerHTML = `
                        <h4 style="margin-bottom: 12px; color: var(--text-primary);">ğŸ“ ãƒãƒ¼ãƒ‰ä¸€è¦§</h4>
                        ${data.nodes.map(node => `
                            <div class="node-item">
                                <div class="node-type">${node.type}</div>
                                <div class="node-text">${node.text}</div>
                                <div class="node-metrics">
                                    <span>æ˜ç¢ºæ€§: ${Math.round(node.clarity * 100)}%</span>
                                    <span>æ·±ã•: ${Math.round(node.depth * 100)}%</span>
                                    <span>ä¿¡é ¼åº¦: ${Math.round(node.confidence * 100)}%</span>
                                </div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    elements.nodesList.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">ã¾ã ãƒãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                }

                // ææ¡ˆ
                if (data.suggestions && data.suggestions.length > 0) {
                    elements.suggestions.innerHTML = `
                        <h4 style="margin-bottom: 12px; color: var(--text-primary);">ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ææ¡ˆ</h4>
                        ${data.suggestions.map(suggestion => `
                            <div style="background: var(--background-color); padding: 12px; 
                                       border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--primary-color);">
                                <div style="font-weight: 500; margin-bottom: 4px;">
                                    ${suggestion.action || suggestion.type}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    ${suggestion.reason || 'æ¨å¥¨ã•ã‚Œã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'}
                                </div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    elements.suggestions.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">ç¾åœ¨ã€ææ¡ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                }
            },

            updateInferenceTab(steps, traceId) {
                if (steps && steps.length > 0) {
                    elements.currentTrace.innerHTML = `
                        <h4 style="margin-bottom: 12px; color: var(--text-primary);">
                            ğŸ” æœ€æ–°ã®æ¨è«–ãƒ—ãƒ­ã‚»ã‚¹ (ID: ${traceId})
                        </h4>
                        ${steps.map((step, index) => `
                            <div class="inference-step">
                                <div class="step-type">
                                    Step ${index + 1}: ${step.step_type.replace('_', ' ')}
                                </div>
                                <div class="step-reasoning">${step.reasoning}</div>
                                <div class="step-metadata">
                                    <span>ä¿¡é ¼åº¦: ${Math.round(step.confidence * 100)}%</span>
                                    <span>å‡¦ç†æ™‚é–“: ${step.processing_time_ms}ms</span>
                                </div>
                            </div>
                        `).join('')}
                    `;
                } else {
                    elements.currentTrace.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">æ¨è«–ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                }
            },

            updateStatsTab(stats) {
                if (stats) {
                    elements.systemStats.innerHTML = `
                        <h4 style="margin-bottom: 16px; color: var(--text-primary);">ğŸ“ˆ ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${stats.system_statistics.total_traces}</div>
                                <div class="stat-label">ç·ãƒˆãƒ¬ãƒ¼ã‚¹æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${Math.round(stats.system_statistics.success_rate * 100)}%</div>
                                <div class="stat-label">æˆåŠŸç‡</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.system_statistics.avg_processing_time_ms}ms</div>
                                <div class="stat-label">å¹³å‡å‡¦ç†æ™‚é–“</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.system_statistics.active_users}</div>
                                <div class="stat-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
                            </div>
                        </div>
                        <div style="background: var(--background-color); padding: 16px; border-radius: 8px; margin-top: 16px;">
                            <h5 style="margin-bottom: 12px;">äººæ°—ã®æ¨è«–ã‚¹ãƒ†ãƒƒãƒ—</h5>
                            ${stats.system_statistics.popular_step_types.map(([type, count]) => `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>${type.replace('_', ' ')}</span>
                                    <span style="font-weight: 500;">${count}å›</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    this.showError(elements.systemStats, 'ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        async function handleSendMessage() {
            console.log('é€ä¿¡ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            const message = elements.messageInput.value.trim();
            console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', message, 'authToken:', authToken);
            
            if (!message) {
                console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã§ã™');
                return;
            }
            if (!authToken) {
                console.log('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“');
                alert('å…ˆã«èªè¨¼ã‚’è¡Œã£ã¦ãã ã•ã„');
                return;
            }

            elements.sendButton.disabled = true;
            elements.messageInput.disabled = true;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            ui.addMessage('user', message);
            elements.messageInput.value = '';

            try {
                // APIå‘¼ã³å‡ºã—
                const response = await api.ontologyChat(message);

                // AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¤º
                ui.addMessage('assistant', response.response, response.timestamp);

                // ãƒˆãƒ¬ãƒ¼ã‚¹IDã‚’ä¿å­˜
                if (response.inference_trace_id) {
                    currentTraceId = response.inference_trace_id;
                }

                // ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                if (response.graph_context) {
                    ui.updateGraphTab(response.graph_context);
                }

                // æ¨è«–ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ›´æ–°
                if (response.inference_steps) {
                    ui.updateInferenceTab(response.inference_steps, response.inference_trace_id);
                }

                // ã‚°ãƒ©ãƒ•çŠ¶æ…‹ã‚’æ›´æ–°
                await updateGraphState();

            } catch (error) {
                ui.addMessage('assistant', `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, new Date());
                console.error('Chat error:', error);
            } finally {
                elements.sendButton.disabled = false;
                elements.messageInput.disabled = false;
                elements.messageInput.focus();
            }
        }

        async function updateGraphState() {
            const userId = elements.userId.value;
            if (!userId || !authToken) return;

            try {
                const data = await api.getGraphState(userId);
                graphData = data;
                ui.updateGraphTab(data);
            } catch (error) {
                console.error('Graph state update error:', error);
            }
        }

        async function updateSystemStats() {
            if (!authToken) return;

            try {
                ui.showLoading(elements.systemStats, 'ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const stats = await api.getSystemStats();
                ui.updateStatsTab(stats);
            } catch (error) {
                ui.showError(elements.systemStats, error.message);
            }
        }

        function setupAuth() {
            const userId = elements.userId.value;
            if (!userId) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            authToken = userId;
            elements.authStatus.textContent = `èªè¨¼æ¸ˆã¿ (User: ${userId})`;
            elements.authStatus.style.color = 'var(--secondary-color)';
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            updateGraphState();
            updateSystemStats();
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;
                
                // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                
                // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                document.querySelectorAll('.tab-panel').forEach(panel => {
                    panel.style.display = 'none';
                });
                document.getElementById(targetTab + 'Tab').style.display = 'block';

                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                if (targetTab === 'stats') {
                    updateSystemStats();
                }
            });
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šé–¢æ•°
        function setupEventListeners() {
            if (!elements.sendButton) {
                console.error('é€ä¿¡ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            elements.authButton.addEventListener('click', setupAuth);
            elements.sendButton.addEventListener('click', handleSendMessage);
            elements.clearChat.addEventListener('click', () => {
                elements.chatMessages.innerHTML = `
                    <div class="message assistant">
                        <div class="message-avatar">ğŸ¤–</div>
                        <div class="message-content">
                            <div>ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚æ–°ã—ã„æ¢ç©¶ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</div>
                            <div class="message-time">${new Date().toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
            });
            elements.refreshGraph.addEventListener('click', updateGraphState);

            elements.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });

            elements.modeToggle.addEventListener('click', () => {
                elements.graphMode.checked = !elements.graphMode.checked;
                elements.modeToggle.textContent = elements.graphMode.checked ? 'ã‚°ãƒ©ãƒ•ãƒ¢ãƒ¼ãƒ‰' : 'é€šå¸¸ãƒ¢ãƒ¼ãƒ‰';
            });

            console.log('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸ', {
                sendButton: elements.sendButton,
                messageInput: elements.messageInput
            });
        }
    </script>
</body>
</html>